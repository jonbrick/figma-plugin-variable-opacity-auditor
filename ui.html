<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Variables Mapper</title>
    <style>
      /* Inline CSS - Required for Figma plugins */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --card: 0 0% 100%;
        --card-foreground: 222.2 84% 4.9%;
        --primary: 222.2 47.4% 11.2%;
        --primary-foreground: 210 40% 98%;
        --secondary: 210 40% 96%;
        --secondary-foreground: 222.2 47.4% 11.2%;
        --muted: 210 40% 96%;
        --muted-foreground: 215.4 16.3% 46.9%;
        --accent: 210 40% 96%;
        --border: 214.3 31.8% 91.4%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 210 40% 98%;
        --radius: 8px;
        --success: 142.1 76.2% 36.3%;
        --warning: 47.9 95.8% 53.1%;
        --info: 221.2 83.2% 53.3%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        font-size: 13px;
        line-height: 1.5;
        color: hsl(var(--foreground));
        background-color: hsl(var(--background));
        padding: 16px;
      }

      #app {
        max-width: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      .section {
        opacity: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .hidden {
        display: none !important;
      }

      /* Header */
      .header {
        text-align: center;
        padding: 12px 0;
        background: hsl(var(--background));
        border-radius: var(--radius);
        margin-bottom: 16px;
      }

      .header h1 {
        font-size: 20px;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
        letter-spacing: -0.025em;
        line-height: 1.2;
      }

      .subtitle {
        color: hsl(var(--muted-foreground));
        font-size: 13px;
        font-weight: 500;
        max-width: 320px;
        margin: 0 auto;
        line-height: 1.3;
      }

      /* Upload area */
      .upload-area {
        border: 2px dashed hsl(var(--border));
        border-radius: calc(var(--radius) + 4px);
        padding: 24px 20px;
        text-align: center;
        background: hsl(var(--background));
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: hsl(var(--primary));
        background: hsl(var(--accent));
      }

      .upload-content .upload-icon {
        font-size: 32px;
        margin-bottom: 8px;
        opacity: 0.7;
      }

      .upload-content h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        color: hsl(var(--foreground));
        line-height: 1.3;
      }

      .upload-content p {
        color: hsl(var(--muted-foreground));
        margin-bottom: 12px;
        font-size: 12px;
        line-height: 1.4;
      }

      .supported-formats {
        text-align: center;
        margin-top: 8px;
      }

      .supported-formats small {
        color: hsl(var(--muted-foreground));
        font-size: 11px;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px 24px;
        background: hsl(var(--card));
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
      }

      .loader {
        width: 28px;
        height: 28px;
        border: 3px solid hsl(var(--muted));
        border-top: 3px solid hsl(var(--primary));
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading p {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 500;
        line-height: 1.4;
      }

      /* Library Info */
      .collections-overview {
        background: hsl(var(--muted) / 0.3);
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 12px 16px;
        margin-bottom: 12px;
      }

      .collections-overview h3 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 0;
        color: hsl(var(--foreground));
      }

      .library-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        padding: 6px 8px;
        background: hsl(var(--background));
        border-radius: calc(var(--radius) - 2px);
        border: 1px solid hsl(var(--border));
      }

      .library-item:last-child {
        margin-bottom: 0;
      }

      .library-main {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
      }

      .library-name {
        font-weight: 600;
        font-size: 12px;
        color: hsl(var(--foreground));
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .library-stats {
        font-size: 10px;
        color: hsl(var(--muted-foreground));
        white-space: nowrap;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
      }

      .collection-item {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        margin-left: 12px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
      }

      /* Collection grid */
      .collection-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }

      .collection-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 16px;
      }

      .collection-card-header {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 12px;
      }

      .collection-icon {
        font-size: 20px;
        line-height: 1;
        flex-shrink: 0;
        margin-top: 1px;
      }

      .collection-title h3 {
        font-size: 14px;
        font-weight: 600;
        color: hsl(var(--foreground));
        margin-bottom: 2px;
        line-height: 1.2;
      }

      .collection-title p {
        color: hsl(var(--muted-foreground));
        font-size: 12px;
        line-height: 1.3;
        margin: 0;
      }

      .collection-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        transition: all 0.2s ease;
      }

      .collection-select:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
      }

      .collection-select:disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      /* Responsive collection grid */
      @media (max-width: 600px) {
        .collection-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Selected collections info */
      .selected-collections-info {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 12px 16px;
        margin-bottom: 16px;
      }

      .selected-collections-info h3 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        color: hsl(var(--foreground));
      }

      .selected-collections-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .selected-collection {
        display: flex;
        flex-direction: column;
        gap: 2px;
        padding: 8px 10px;
        background: hsl(var(--muted) / 0.3);
        border-radius: calc(var(--radius) - 2px);
        border: 1px solid hsl(var(--border));
      }

      .selected-label {
        font-size: 10px;
        font-weight: 600;
        color: hsl(var(--muted-foreground));
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .selected-value {
        font-size: 12px;
        font-weight: 600;
        color: hsl(var(--foreground));
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
      }

      /* Responsive selected collections */
      @media (max-width: 600px) {
        .selected-collections-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Large collection warning */
      .large-collection-warning {
        background: hsl(var(--warning) / 0.1);
        border: 1px solid hsl(var(--warning) / 0.3);
        border-radius: var(--radius);
        padding: 12px 16px;
        margin-bottom: 16px;
      }

      .large-collection-warning h4 {
        font-size: 13px;
        font-weight: 600;
        color: hsl(var(--warning));
        margin-bottom: 4px;
      }

      .large-collection-warning p {
        font-size: 12px;
        color: hsl(var(--muted-foreground));
        line-height: 1.4;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
        padding: 0 20px;
        height: 44px;
        gap: 8px;
      }

      .btn:disabled {
        pointer-events: none;
        opacity: 0.5;
      }

      .btn-primary {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border: 1px solid hsl(var(--primary));
      }

      .btn-primary:hover:not(:disabled) {
        background: hsl(var(--primary) / 0.9);
      }

      .btn-secondary {
        background: hsl(var(--secondary));
        color: hsl(var(--secondary-foreground));
        border: 1px solid hsl(var(--border));
      }

      .btn-secondary:hover:not(:disabled) {
        background: hsl(var(--muted));
      }

      /* Collection groups */
      .collection-group {
        margin-bottom: 12px;
      }

      .collection-group:last-child {
        margin-bottom: 0;
      }

      .collection-group-header {
        font-size: 11px;
        font-weight: 600;
        color: hsl(var(--muted-foreground));
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        padding-left: 4px;
      }

      /* Actions */
      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 8px;
        padding-bottom: 16px;
      }

      .actions .btn {
        width: 100%;
      }

      .collections-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .refresh-btn {
        background: none;
        border: none;
        font-size: 14px;
        cursor: pointer;
        padding: 4px;
        border-radius: calc(var(--radius) - 2px);
        color: hsl(var(--muted-foreground));
        transition: all 0.2s ease;
      }

      .refresh-btn:hover {
        background: hsl(var(--muted));
        color: hsl(var(--foreground));
      }

      .refresh-btn:active {
        transform: rotate(180deg);
      }

      /* Cards */
      .summary-card,
      .result-group,
      .error-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .summary-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
      }

      .summary-row {
        display: flex;
        gap: 12px;
      }

      .summary-card {
        flex: 1;
        padding: 24px 20px;
        text-align: center;
      }

      .summary-card.success {
        border-color: hsl(var(--success) / 0.3);
        background: hsl(var(--success) / 0.05);
      }

      .summary-card.info {
        border-color: hsl(var(--info) / 0.3);
        background: hsl(var(--info) / 0.05);
      }

      .summary-card.warning {
        border-color: hsl(var(--warning) / 0.3);
        background: hsl(var(--warning) / 0.05);
      }

      .summary-card.error {
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
      }

      .summary-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .stat-number {
        font-size: 32px;
        font-weight: 800;
        color: hsl(var(--primary));
        line-height: 1;
      }

      .summary-card.success .stat-number {
        color: hsl(var(--success));
      }

      .summary-card.info .stat-number {
        color: hsl(var(--info));
      }

      .summary-card.warning .stat-number {
        color: hsl(var(--warning));
      }

      .summary-card.error .stat-number {
        color: hsl(var(--destructive));
      }

      .stat-label {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 600;
      }

      /* Result groups */
      .result-group {
        margin-bottom: 8px;
        overflow: visible;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
      }

      .result-title {
        padding: 12px 16px;
        background: hsl(var(--muted));
        border-bottom: 1px solid hsl(var(--border));
        font-size: 13px;
        font-weight: 600;
        margin: 0;
        color: hsl(var(--foreground));
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }

      .result-title:hover {
        background: hsl(var(--muted) / 0.8);
      }

      .result-title::after {
        content: "▼";
        font-size: 10px;
        color: hsl(var(--muted-foreground));
        transition: transform 0.2s ease;
      }

      .result-group.collapsed .result-title::after {
        transform: rotate(-90deg);
      }

      .result-group.collapsed .variable-list {
        display: none;
      }

      .result-group.collapsed .result-title {
        border-bottom: none;
      }

      .result-count {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        background: hsl(var(--background));
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
      }

      .variable-list {
        padding: 0;
        max-height: none;
        overflow-y: visible;
        transition: all 0.2s ease;
      }

      .variable-item {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        border-bottom: 1px solid hsl(var(--border));
      }

      .variable-item:last-child {
        border-bottom: none;
      }

      .variable-item:hover {
        background: hsl(var(--muted) / 0.3);
      }

      .variable-name {
        font-weight: 700;
        color: hsl(var(--foreground));
        font-size: 13px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        line-height: 1.3;
        word-break: break-all;
      }

      .variable-references {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: hsl(var(--muted) / 0.3);
        padding: 12px;
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
      }

      .reference-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 11px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        word-break: break-all;
      }

      .reference-label {
        color: hsl(var(--muted-foreground));
        font-weight: 500;
      }

      .reference-value {
        color: hsl(var(--foreground));
        font-weight: 600;
      }

      .error-text {
        color: hsl(var(--destructive));
        font-weight: 500;
        font-size: 11px;
        line-height: 1.4;
        word-break: break-word;
      }

      /* Error card */
      .error-card {
        padding: 32px 24px;
        text-align: center;
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
      }

      .error-card h3 {
        color: hsl(var(--destructive));
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.3;
      }

      .error-card p {
        color: hsl(var(--destructive) / 0.8);
        margin-bottom: 24px;
        font-size: 14px;
        line-height: 1.4;
      }

      /* Responsive */
      @media (max-width: 480px) {
        body {
          padding: 16px;
        }

        .summary-grid {
          grid-template-columns: 1fr;
          grid-template-rows: repeat(4, 1fr);
        }

        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>Variables Mapper</h1>
        <p class="subtitle">
          Map CSS @theme variables to Figma variables <br />
          with shared library references
        </p>
      </div>

      <div id="collection-section" class="section">
        <div class="collections-overview" id="library-info">
          <div class="collections-header">
            <h3>📚 Available Collections</h3>
            <button
              id="refresh-collections-btn"
              class="refresh-btn"
              title="Refresh collections"
            >
              🔄
            </button>
          </div>
          <div id="library-list"></div>
        </div>

        <div class="collection-grid">
          <div class="collection-card">
            <div class="collection-card-header">
              <div class="collection-icon">🏠</div>
              <div class="collection-title">
                <h3>Source Collection</h3>
                <p>Library with design tokens to reference</p>
              </div>
            </div>
            <select id="source-collection-select" class="collection-select">
              <option value="">Choose source collection...</option>
            </select>
          </div>

          <div class="collection-card">
            <div class="collection-card-header">
              <div class="collection-icon">🎯</div>
              <div class="collection-title">
                <h3>Target Collection</h3>
                <p>Local collection to create variables in</p>
              </div>
            </div>
            <select id="target-collection-select" class="collection-select">
              <option value="">Choose target collection...</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button id="preview-btn" class="btn btn-primary" disabled>
            Next: Upload CSS File
          </button>
        </div>
      </div>

      <div id="upload-section" class="section hidden">
        <div class="selected-collections-info">
          <h3>📋 Selected Collections</h3>
          <div class="selected-collections-grid">
            <div class="selected-collection">
              <span class="selected-label">Source:</span>
              <span id="selected-source" class="selected-value"></span>
            </div>
            <div class="selected-collection">
              <span class="selected-label">Target:</span>
              <span id="selected-target" class="selected-value"></span>
            </div>
          </div>
        </div>

        <div class="upload-area" id="upload-area">
          <div class="upload-content">
            <div class="upload-icon">📁</div>
            <h3>Upload CSS File</h3>
            <p>Drag & drop your CSS file with @theme variables</p>
            <input type="file" id="file-input" accept=".css" hidden />
            <button id="browse-btn" class="btn btn-primary">Choose File</button>
          </div>
        </div>
        <div class="supported-formats">
          <small>Supported: .css files with @theme and light/dark modes</small>
        </div>
        <div class="actions">
          <button id="back-btn" class="btn btn-secondary">Back</button>
        </div>
      </div>

      <div id="json-upload-section" class="section hidden">
        <div class="selected-collections-info">
          <h3>📋 Selected Collections</h3>
          <div class="selected-collections-grid">
            <div class="selected-collection">
              <span class="selected-label">Source:</span>
              <span id="json-selected-source" class="selected-value"></span>
            </div>
            <div class="selected-collection">
              <span class="selected-label">Target:</span>
              <span id="json-selected-target" class="selected-value"></span>
            </div>
          </div>
        </div>

        <div class="large-collection-warning">
          <h4>⚡ Large Collection Detected</h4>
          <p>
            Your source collection has
            <span id="collection-size-display">500+</span> variables. For
            optimal performance, upload a JSON export of your variable
            collection.
          </p>
        </div>

        <div class="upload-area" id="json-upload-area">
          <div class="upload-content">
            <div class="upload-icon">📄</div>
            <h3>Upload Variables JSON (Optional)</h3>
            <p>
              Export your Figma variables collection as JSON for faster
              processing
            </p>
            <input type="file" id="json-file-input" accept=".json" hidden />
            <button id="json-browse-btn" class="btn btn-primary">
              Choose JSON File
            </button>
          </div>
        </div>
        <div class="supported-formats">
          <small
            >Supported: .json files exported from Figma variable
            collections</small
          >
        </div>
        <div class="actions">
          <button id="json-skip-btn" class="btn btn-secondary">
            Skip (Use Standard Method)
          </button>
          <button id="json-continue-btn" class="btn btn-primary" disabled>
            Continue to Preview
          </button>
        </div>
      </div>

      <div id="loading-section" class="section hidden">
        <div class="loading">
          <div class="loader"></div>
          <p id="loading-text">Parsing CSS file...</p>
        </div>
      </div>

      <div id="preview-section" class="section hidden">
        <div class="summary-card">
          <div class="summary-stat">
            <span class="stat-number" id="preview-total">0</span>
            <span class="stat-label">theme variables found</span>
          </div>
        </div>

        <div class="actions">
          <button id="apply-btn" class="btn btn-primary" disabled>
            Apply Changes
          </button>
          <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
        </div>

        <h2>👀 Preview</h2>

        <div id="preview-variables" class="result-group">
          <h3 class="result-title">🎨 Variables to Create</h3>
          <div id="preview-variables-list" class="variable-list"></div>
        </div>
      </div>

      <div id="results-section" class="section hidden">
        <h2>🎉 Results</h2>

        <div class="summary-grid">
          <div class="summary-row">
            <div class="summary-card success">
              <div class="summary-stat">
                <span class="stat-number" id="created-count">0</span>
                <span class="stat-label">✅ Created</span>
              </div>
            </div>
            <div class="summary-card info">
              <div class="summary-stat">
                <span class="stat-number" id="updated-count">0</span>
                <span class="stat-label">🔄 Updated</span>
              </div>
            </div>
          </div>
          <div class="summary-row">
            <div class="summary-card error">
              <div class="summary-stat">
                <span class="stat-number" id="removed-count">0</span>
                <span class="stat-label">🗑️ Removed</span>
              </div>
            </div>
            <div class="summary-card warning">
              <div class="summary-stat">
                <span class="stat-number" id="failed-count">0</span>
                <span class="stat-label">⚠️ Failed</span>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="upload-new-btn" class="btn btn-secondary">
            Upload New File
          </button>
          <button id="close-btn" class="btn btn-primary">Close</button>
        </div>

        <div id="results-created" class="result-group">
          <h3 class="result-title">✅ Created Variables</h3>
          <div id="results-created-list" class="variable-list"></div>
        </div>

        <div id="results-updated" class="result-group">
          <h3 class="result-title">🔄 Updated Variables</h3>
          <div id="results-updated-list" class="variable-list"></div>
        </div>

        <div id="results-removed" class="result-group">
          <h3 class="result-title">🗑️ Removed Variables</h3>
          <div id="results-removed-list" class="variable-list"></div>
        </div>

        <div id="results-failed" class="result-group">
          <h3 class="result-title">⚠️ Failed Variables</h3>
          <div id="results-failed-list" class="variable-list"></div>
        </div>
      </div>

      <div id="error-section" class="section hidden">
        <div class="error-card">
          <h3>⚠️ Error</h3>
          <p id="error-message">Something went wrong.</p>
          <button id="retry-btn" class="btn btn-primary">
            Upload New File
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("Plugin UI loaded");

      var isProcessing = false;
      var currentResults = null;
      var availableCollections = [];
      var libraryCollections = [];
      var localCollections = [];
      var selectedSourceCollection = null;
      var uploadedJsonData = null;

      document.addEventListener("DOMContentLoaded", function () {
        var elements = {
          fileInput: document.getElementById("file-input"),
          browseBtn: document.getElementById("browse-btn"),
          uploadArea: document.getElementById("upload-area"),
          jsonFileInput: document.getElementById("json-file-input"),
          jsonBrowseBtn: document.getElementById("json-browse-btn"),
          jsonUploadArea: document.getElementById("json-upload-area"),
          jsonSkipBtn: document.getElementById("json-skip-btn"),
          jsonContinueBtn: document.getElementById("json-continue-btn"),
          sourceCollectionSelect: document.getElementById(
            "source-collection-select"
          ),
          targetCollectionSelect: document.getElementById(
            "target-collection-select"
          ),
          previewBtn: document.getElementById("preview-btn"),
          backBtn: document.getElementById("back-btn"),
          uploadNewBtn: document.getElementById("upload-new-btn"),
          closeBtn: document.getElementById("close-btn"),
          retryBtn: document.getElementById("retry-btn"),
          cancelBtn: document.getElementById("cancel-btn"),
          applyBtn: document.getElementById("apply-btn"),
          loadingText: document.getElementById("loading-text"),
          selectedInfo: document.getElementById("selected-info"),
          selectedSource: document.getElementById("selected-source"),
          selectedTarget: document.getElementById("selected-target"),
          jsonSelectedSource: document.getElementById("json-selected-source"),
          jsonSelectedTarget: document.getElementById("json-selected-target"),
          collectionSizeDisplay: document.getElementById(
            "collection-size-display"
          ),
          refreshCollectionsBtn: document.getElementById(
            "refresh-collections-btn"
          ),
        };

        // File input listeners
        if (elements.fileInput) {
          elements.fileInput.addEventListener("change", function (event) {
            if (isProcessing) return;
            var file = event.target.files[0];
            if (file) processFile(file);
          });
        }

        if (elements.jsonFileInput) {
          elements.jsonFileInput.addEventListener("change", function (event) {
            if (isProcessing) return;
            var file = event.target.files[0];
            if (file) processJsonFile(file);
          });
        }

        // Button listeners
        if (elements.browseBtn) {
          elements.browseBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            if (!isProcessing && elements.fileInput) elements.fileInput.click();
          });
        }

        if (elements.jsonBrowseBtn) {
          elements.jsonBrowseBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            if (!isProcessing && elements.jsonFileInput)
              elements.jsonFileInput.click();
          });
        }

        if (elements.uploadArea) {
          elements.uploadArea.addEventListener("click", function (e) {
            if (
              e.target === elements.browseBtn ||
              (elements.browseBtn && elements.browseBtn.contains(e.target))
            )
              return;
            if (!isProcessing && elements.fileInput) elements.fileInput.click();
          });
        }

        if (elements.jsonUploadArea) {
          elements.jsonUploadArea.addEventListener("click", function (e) {
            if (
              e.target === elements.jsonBrowseBtn ||
              (elements.jsonBrowseBtn &&
                elements.jsonBrowseBtn.contains(e.target))
            )
              return;
            if (!isProcessing && elements.jsonFileInput)
              elements.jsonFileInput.click();
          });
        }

        if (elements.sourceCollectionSelect) {
          elements.sourceCollectionSelect.addEventListener(
            "change",
            updatePreviewButton
          );
        }

        if (elements.targetCollectionSelect) {
          elements.targetCollectionSelect.addEventListener(
            "change",
            updatePreviewButton
          );
        }

        if (elements.previewBtn) {
          elements.previewBtn.addEventListener("click", function () {
            updateSelectedInfo();
            showSection("upload-section");
          });
        }

        if (elements.backBtn) {
          elements.backBtn.addEventListener("click", function () {
            showSection("collection-section");
          });
        }

        if (elements.jsonSkipBtn) {
          elements.jsonSkipBtn.addEventListener("click", function () {
            uploadedJsonData = null;
            showSection("preview-section");
          });
        }

        if (elements.jsonContinueBtn) {
          elements.jsonContinueBtn.addEventListener("click", function () {
            if (currentResults) {
              displayPreview(currentResults);
            }
            showSection("preview-section");
          });
        }

        if (elements.cancelBtn) {
          elements.cancelBtn.addEventListener("click", resetToUpload);
        }
        if (elements.uploadNewBtn) {
          elements.uploadNewBtn.addEventListener("click", resetToUpload);
        }
        if (elements.retryBtn) {
          elements.retryBtn.addEventListener("click", resetToUpload);
        }

        if (elements.applyBtn) {
          elements.applyBtn.addEventListener("click", function () {
            var selectedSourceCollection =
              elements.sourceCollectionSelect.value;
            var selectedTargetCollection =
              elements.targetCollectionSelect.value;

            if (
              currentResults &&
              currentResults.variables &&
              selectedSourceCollection &&
              selectedTargetCollection
            ) {
              // Find source collection type
              var sourceCollectionType = "local"; // default
              for (var i = 0; i < availableCollections.length; i++) {
                if (availableCollections[i].id === selectedSourceCollection) {
                  sourceCollectionType = availableCollections[i].type;
                  break;
                }
              }

              createVariables(
                currentResults.variables,
                selectedSourceCollection,
                sourceCollectionType,
                "existing", // Always use existing collection
                selectedTargetCollection
              );
            }
          });
        }

        if (elements.closeBtn) {
          elements.closeBtn.addEventListener("click", function () {
            parent.postMessage(
              { pluginMessage: { type: "close-plugin" } },
              "*"
            );
          });
        }

        if (elements.refreshCollectionsBtn) {
          elements.refreshCollectionsBtn.addEventListener(
            "click",
            loadCollections
          );
        }

        // Message handler
        window.onmessage = function (event) {
          var pluginMessage = event.data.pluginMessage;
          var type = pluginMessage.type;
          var success = pluginMessage.success;
          var results = pluginMessage.results;
          var message = pluginMessage.message;
          var sourceCollections = pluginMessage.sourceCollections;
          var targetCollections = pluginMessage.targetCollections;
          var warning = pluginMessage.warning;

          switch (type) {
            case "collections-loaded":
              if (success) {
                availableCollections = sourceCollections;
                libraryCollections = sourceCollections.filter(function (c) {
                  return c.type === "library";
                });
                localCollections = sourceCollections.filter(function (c) {
                  return c.type === "local";
                });
                displayCollectionInfo(sourceCollections);
                populateCollections(libraryCollections, localCollections);
                if (warning) {
                  console.warn("⚠️ " + warning);
                }
              } else {
                displayError(message || "Failed to load collections");
              }
              break;

            case "parsing-complete":
              isProcessing = false;
              if (success) {
                currentResults = results;

                // Check if we need JSON upload
                if (
                  selectedSourceCollection &&
                  selectedSourceCollection.variableCount >= 500
                ) {
                  showJsonUploadSection();
                } else {
                  displayPreview(currentResults);
                  showSection("preview-section");
                }
              } else {
                displayError(message);
                showSection("error-section");
              }
              break;

            case "creation-complete":
              isProcessing = false;
              if (success) {
                displayCreationResults(results);
                showSection("results-section");
              } else {
                displayError(message);
                showSection("error-section");
              }
              break;
          }
        };

        function updatePreviewButton() {
          var source = elements.sourceCollectionSelect.value;
          var target = elements.targetCollectionSelect.value;
          elements.previewBtn.disabled = !(source && target);

          // Store selected source collection for size checking
          if (source) {
            selectedSourceCollection = availableCollections.find(function (c) {
              return c.id === source;
            });
          }
        }

        function updateSelectedInfo() {
          var sourceIdx = elements.sourceCollectionSelect.selectedIndex;
          var targetIdx = elements.targetCollectionSelect.selectedIndex;
          var sourceOption = elements.sourceCollectionSelect.options[sourceIdx];
          var targetOption = elements.targetCollectionSelect.options[targetIdx];

          // Find the original collection objects
          var sourceCollection = availableCollections.find(function (c) {
            return c.id === sourceOption.value;
          });

          var displayName = sourceCollection
            ? sourceCollection.displayName
            : sourceOption.text;
          var targetName = targetOption.text;

          elements.selectedSource.innerHTML = displayName;
          elements.selectedTarget.innerHTML = targetName;

          // Also update JSON section
          elements.jsonSelectedSource.innerHTML = displayName;
          elements.jsonSelectedTarget.innerHTML = targetName;
        }

        function showJsonUploadSection() {
          // Update collection size display
          elements.collectionSizeDisplay.innerHTML =
            selectedSourceCollection.variableCount;

          // Update selected collections info
          updateSelectedInfo();

          showSection("json-upload-section");
        }

        function populateCollections(libs, locals) {
          libraryCollections = libs;
          localCollections = locals;
          var sourceSel = elements.sourceCollectionSelect;
          var targetSel = elements.targetCollectionSelect;
          sourceSel.innerHTML = "";
          targetSel.innerHTML = "";

          // Add default options
          sourceSel.innerHTML =
            '<option value="">Choose source collection...</option>';
          targetSel.innerHTML =
            '<option value="">Choose target collection...</option>';

          // Add library collections to source
          for (var i = 0; i < libs.length; i++) {
            var opt = document.createElement("option");
            opt.value = libs[i].id;
            opt.text =
              libs[i].displayName ||
              libs[i].libraryName + " → " + libs[i].collectionName;
            sourceSel.appendChild(opt);
          }

          // Add local collections to target
          for (var j = 0; j < locals.length; j++) {
            var opt2 = document.createElement("option");
            opt2.value = locals[j].id;
            // Remove "(Local)" suffix if present since it's redundant in the target dropdown
            opt2.text = locals[j].displayName
              ? locals[j].displayName.replace(" (Local)", "")
              : locals[j].collectionName;
            targetSel.appendChild(opt2);
          }

          // Default to first library and first local
          if (libs.length > 0) {
            sourceSel.value = libs[0].id;
            selectedSourceCollection = libs[0];
          }
          if (locals.length > 0) targetSel.value = locals[0].id;
          updatePreviewButton();
        }

        // Load collections on page load
        loadCollections();

        // Add accordion functionality to result groups
        document.addEventListener("click", function (e) {
          if (e.target.classList.contains("result-title")) {
            var resultGroup = e.target.closest(".result-group");
            if (resultGroup) {
              resultGroup.classList.toggle("collapsed");
            }
          }
        });
      });

      function processFile(file) {
        if (isProcessing) return;
        isProcessing = true;

        if (!file.name.endsWith(".css")) {
          displayError("Please upload a CSS file (.css extension required).");
          showSection("error-section");
          isProcessing = false;
          return;
        }

        showSection("loading-section");

        var reader = new FileReader();
        reader.onload = function (e) {
          parent.postMessage(
            {
              pluginMessage: { type: "parse-css", cssContent: e.target.result },
            },
            "*"
          );
        };

        reader.onerror = function () {
          console.error("File read error");
          displayError("Error reading file. Please try again.");
          showSection("error-section");
          isProcessing = false;
        };

        reader.readAsText(file);
      }

      function processJsonFile(file) {
        if (isProcessing) return;

        if (!file.name.endsWith(".json")) {
          displayError("Please upload a JSON file (.json extension required).");
          return;
        }

        var reader = new FileReader();
        reader.onload = function (e) {
          try {
            uploadedJsonData = JSON.parse(e.target.result);
            console.log(
              "JSON data loaded:",
              Object.keys(uploadedJsonData).length + " variables"
            );

            // Enable continue button
            var continueBtn = document.getElementById("json-continue-btn");
            if (continueBtn) {
              continueBtn.disabled = false;
              continueBtn.innerHTML =
                "Continue to Preview (" +
                Object.keys(uploadedJsonData).length +
                " variables loaded)";
            }
          } catch (error) {
            console.error("JSON parse error:", error);
            displayError(
              "Invalid JSON file. Please check the format and try again."
            );
            uploadedJsonData = null;
          }
        };

        reader.onerror = function () {
          console.error("JSON file read error");
          displayError("Error reading JSON file. Please try again.");
          uploadedJsonData = null;
        };

        reader.readAsText(file);
      }

      function loadCollections() {
        document.getElementById("loading-text").textContent =
          "Loading collections...";
        parent.postMessage({ pluginMessage: { type: "get-collections" } }, "*");
      }

      function createVariables(
        variables,
        selectedSourceCollectionId,
        sourceCollectionType,
        collectionChoice,
        existingCollectionId
      ) {
        if (isProcessing) return;
        isProcessing = true;

        document.getElementById("loading-text").textContent =
          "Creating variables...";
        showSection("loading-section");

        parent.postMessage(
          {
            pluginMessage: {
              type: "create-variables",
              variablesToCreate: variables,
              selectedSourceCollectionId: selectedSourceCollectionId,
              sourceCollectionType: sourceCollectionType,
              collectionChoice: collectionChoice,
              existingCollectionId: existingCollectionId,
              jsonData: uploadedJsonData, // Pass JSON data to plugin
            },
          },
          "*"
        );
      }

      function displayCollectionInfo(collections) {
        var collectionList = document.getElementById("library-list");

        if (!collections || collections.length === 0) {
          collectionList.innerHTML =
            '<div style="color: hsl(var(--muted-foreground)); font-style: italic; text-align: center; padding: 8px;">No variable collections found</div>';
          return;
        }

        // Group collections by type, preserving original order
        var libraryCollections = collections.filter(function (c) {
          return c.type === "library";
        });
        var localCollections = collections.filter(function (c) {
          return c.type === "local";
        });

        var html = "";

        // Library collections
        if (libraryCollections.length > 0) {
          html += '<div class="collection-group">';
          html +=
            '<div class="collection-group-header">📚 Library Collections</div>';
          for (var i = 0; i < libraryCollections.length; i++) {
            html += createCollectionItem(libraryCollections[i]);
          }
          html += "</div>";
        }

        // Local collections
        if (localCollections.length > 0) {
          html += '<div class="collection-group">';
          html +=
            '<div class="collection-group-header">📁 Local Collections</div>';
          for (var j = 0; j < localCollections.length; j++) {
            html += createCollectionItem(localCollections[j]);
          }
          html += "</div>";
        }

        collectionList.innerHTML = html;
      }

      function createCollectionItem(collection) {
        var html = '<div class="library-item">';
        html += '<div class="library-main">';
        html +=
          '<div class="library-name">' +
          (collection.type === "library"
            ? collection.displayName
            : collection.displayName || collection.collectionName) +
          "</div>";
        html += "</div>";
        html +=
          '<div class="library-stats">' +
          collection.variableCount +
          " vars" +
          (collection.modeCount
            ? " • " + collection.modeCount + " modes"
            : "") +
          "</div>";
        html += "</div>";

        return html;
      }

      function showSection(sectionId) {
        var sections = [
          "collection-section",
          "upload-section",
          "json-upload-section",
          "loading-section",
          "preview-section",
          "results-section",
          "error-section",
        ];
        for (var i = 0; i < sections.length; i++) {
          var section = document.getElementById(sections[i]);
          if (section)
            section.className =
              "section" + (sections[i] === sectionId ? "" : " hidden");
        }
      }

      function resetToUpload() {
        isProcessing = false;
        currentResults = null;
        availableCollections = [];
        selectedSourceCollection = null;
        uploadedJsonData = null;
        document.getElementById("loading-text").textContent =
          "Parsing CSS file...";

        // Reset source collection select
        var sourceCollectionSelect = document.getElementById(
          "source-collection-select"
        );
        sourceCollectionSelect.innerHTML =
          '<option value="">Choose source collection...</option>';

        // Reset target collection select
        var targetCollectionSelect = document.getElementById(
          "target-collection-select"
        );
        targetCollectionSelect.innerHTML =
          '<option value="">Choose target collection...</option>';

        // Reset JSON continue button
        var continueBtn = document.getElementById("json-continue-btn");
        if (continueBtn) {
          continueBtn.disabled = true;
          continueBtn.innerHTML = "Continue to Preview";
        }

        showSection("collection-section");
        var fileInput = document.getElementById("file-input");
        if (fileInput) fileInput.value = "";
        var jsonFileInput = document.getElementById("json-file-input");
        if (jsonFileInput) jsonFileInput.value = "";
      }

      function displayPreview(results) {
        document.getElementById("preview-total").textContent =
          results.totalFound;

        populateVariableList(
          "preview-variables",
          "preview-variables-list",
          results.variables,
          "preview"
        );

        // Enable apply button if collections are selected
        var sourceCollectionSelect = document.getElementById(
          "source-collection-select"
        );
        var targetCollectionSelect = document.getElementById(
          "target-collection-select"
        );
        var applyBtn = document.getElementById("apply-btn");

        if (
          sourceCollectionSelect.value &&
          targetCollectionSelect.value &&
          results.variables &&
          results.variables.length > 0
        ) {
          applyBtn.disabled = false;
        } else {
          applyBtn.disabled = true;
        }
      }

      function displayCreationResults(results) {
        document.getElementById("created-count").textContent = results.created
          ? results.created.length
          : 0;
        document.getElementById("updated-count").textContent = results.updated
          ? results.updated.length
          : 0;
        document.getElementById("removed-count").textContent = 0; // Or handle if you plan to send 'removed'
        document.getElementById("failed-count").textContent = results.failed
          ? results.failed.length
          : 0;

        populateVariableList(
          "results-created",
          "results-created-list",
          results.created || [],
          "created"
        );
        populateVariableList(
          "results-updated",
          "results-updated-list",
          results.updated || [],
          "updated"
        );
        populateVariableList(
          "results-removed", // This section might remain hidden if not used
          "results-removed-list",
          [], // No 'removed' data is currently sent
          "removed"
        );
        populateVariableList(
          "results-failed",
          "results-failed-list",
          results.failed || [],
          "failed"
        );
      }

      function populateVariableList(sectionId, listId, items, type) {
        var section = document.getElementById(sectionId);
        var list = document.getElementById(listId);

        if (items && items.length > 0) {
          list.innerHTML = "";

          for (var i = 0; i < items.length; i++) {
            list.appendChild(createVariableItem(items[i], type));
          }

          // Update title with count
          var title = section.querySelector(".result-title");
          var existingCount = title.querySelector(".result-count");
          if (existingCount) {
            existingCount.remove();
          }
          var countSpan = document.createElement("span");
          countSpan.className = "result-count";
          countSpan.textContent =
            items.length +
            " " +
            (type === "preview"
              ? "variables"
              : type === "created"
              ? "created"
              : type === "updated"
              ? "updated"
              : "failed");
          title.appendChild(countSpan);

          if (section) section.classList.remove("hidden");
        } else {
          if (section) section.classList.add("hidden");
        }
      }

      function createVariableItem(item, type) {
        var div = document.createElement("div");
        div.className = "variable-item";

        // Variable name
        var nameDiv = document.createElement("div");
        nameDiv.className = "variable-name";
        nameDiv.textContent = item.variableName;

        // Variable references
        var referencesDiv = document.createElement("div");
        referencesDiv.className = "variable-references";

        // Light mode reference
        var lightRef = document.createElement("div");
        lightRef.className = "reference-item";
        lightRef.innerHTML =
          '<span class="reference-label">Light:</span>' +
          '<span class="reference-value">' +
          item.lightReference +
          "</span>";

        // Dark mode reference
        var darkRef = document.createElement("div");
        darkRef.className = "reference-item";
        darkRef.innerHTML =
          '<span class="reference-label">Dark:</span>' +
          '<span class="reference-value">' +
          item.darkReference +
          "</span>";

        referencesDiv.appendChild(lightRef);
        referencesDiv.appendChild(darkRef);

        // For results, show which source variables were used
        if (type === "created" || type === "updated") {
          if (item.lightSourceVar) {
            lightRef.innerHTML =
              '<span class="reference-label">Light:</span>' +
              '<span class="reference-value">' +
              item.lightSourceVar +
              "</span>";
          }
          if (item.darkSourceVar) {
            darkRef.innerHTML =
              '<span class="reference-label">Dark:</span>' +
              '<span class="reference-value">' +
              item.darkSourceVar +
              "</span>";
          }
        }

        // For failed items, show error
        if (type === "failed" && item.error) {
          var errorDiv = document.createElement("div");
          errorDiv.className = "error-text";
          errorDiv.textContent = "Error: " + item.error;
          referencesDiv.appendChild(errorDiv);
        }

        div.appendChild(nameDiv);
        div.appendChild(referencesDiv);

        return div;
      }

      function displayError(message) {
        console.error("Plugin error:", message);
        document.getElementById("error-message").textContent = message;
      }
    </script>
  </body>
</html>
